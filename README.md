currently probably half broken, major refactor in dev branch
